
{% extends "base.html" %} 
{% block content %}
<style>
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card-hover:hover { transform: translateY(-3px); transition: all 0.3s ease; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .pulse-btn { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
    .form-floating > .form-control:focus ~ label { color: #DD2476; font-weight: bold; }
    .form-floating > .form-control:focus { border-color: #DD2476; box-shadow: 0 0 0 0.25rem rgba(221, 36, 118, 0.25); }
</style>

<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
    <h3 class="fw-bold"><i class="fa-solid fa-industry me-2"></i>Operator Dashboard</h3>
    <a href="{{ url_for('settings') }}" class="btn btn-dark shadow-sm"><i class="fa-solid fa-gear me-2"></i>Coil Settings</a>
</div>

<div class="row g-4 fade-in">
    <div class="col-lg-8">
        <form id="calcForm" method="POST" action="{{ url_for('confirm_injection') }}">
            <div class="card shadow-sm border-0 mb-4 card-hover">
                <div class="card-header grad-heat py-3"><h5 class="m-0 fw-bold"><i class="fa-solid fa-fire me-2"></i>Heat Parameters</h5></div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6"><div class="form-floating"><input type="text" class="form-control fw-bold" id="heat_id" name="heat_id" required><label>Heat ID</label></div></div>
                        <div class="col-md-6"><div class="form-floating"><input type="text" class="form-control" id="lf_number" name="lf_number" required><label>LF Number</label></div></div>
                        <div class="col-md-4"><div class="form-floating"><input type="number" step="0.1" class="form-control" id="tonnage" name="tonnage" value="150" required><label>Tonnage</label></div></div>
                        <div class="col-md-4"><div class="form-floating"><input type="number" class="form-control" id="temp" name="temp" value="1580" required><label>Temp (Â°C)</label></div></div>
                        <div class="col-md-4"><div class="form-floating"><input type="number" class="form-control" id="freeboard" name="freeboard" value="400"><label>Freeboard</label></div></div>
                    </div>
                </div>
            </div>
            <div class="card shadow-sm border-0 card-hover">
                <div class="card-header grad-chem py-3"><h5 class="m-0 fw-bold"><i class="fa-solid fa-flask me-2"></i>Chemistry</h5></div>
                <div class="card-body p-4 bg-light">
                    <div class="row g-3">
                        <div class="col-md-4"><label class="small fw-bold text-muted">Al%</label><input type="number" step="0.001" class="form-control" id="al" name="al" value="0.040"></div>
                        <div class="col-md-4"><label class="small fw-bold text-muted">S%</label><input type="number" step="0.001" class="form-control" id="s" name="s" value="0.005"></div>
                        <div class="col-md-4"><label class="small fw-bold text-muted">Si%</label><input type="number" step="0.001" class="form-control" id="si" name="si_pct" value="0.200"></div>
                        <div class="col-md-6"><label class="small fw-bold text-muted">Initial P%</label><input type="number" step="0.001" class="form-control" id="p_initial" name="p_initial" value="0.012"></div>
                        <div class="col-md-6"><label class="small fw-bold text-muted">Current P%</label><input type="number" step="0.001" class="form-control" id="p_before" name="p_before" value="0.015"></div>
                        <input type="hidden" id="speed" value="120">
                        <input type="hidden" id="calculated_length_hidden" name="calculated_length_hidden" value="0">
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4 grad-dark">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-2"><span class="text-white-50 small">ACTIVE COIL</span><span class="badge bg-light text-dark">{{ coil.coil_number }}</span></div>
                <h2 class="fw-bold mb-3">{{ "%.0f"|format(coil.current_length) }} <span class="fs-6 text-white-50">m left</span></h2>
                {% set pct = (coil.current_length / coil.total_length * 100) if coil.total_length > 0 else 0 %}
                <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);"><div class="progress-bar bg-success" style="width: {{ pct }}%"></div></div>
            </div>
        </div>
        <div class="card h-100 border-0 shadow-lg text-white" style="background: linear-gradient(180deg, #2C3E50 0%, #000000 100%);">
            <div class="card-body d-flex flex-column justify-content-between p-4">
                <div class="text-center py-4 rounded-4 mb-4" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                    <span class="small text-info text-uppercase fw-bold">Required Wire</span>
                    <h1 class="display-2 fw-bolder my-2"><span id="resultDisplay">0</span><span class="fs-4 text-white-50">m</span></h1>
                    <div class="badge bg-dark border border-secondary px-3 py-2"><i class="fa-regular fa-clock me-1"></i> <span id="timeDisplay">0.0 min</span></div>
                </div>
                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-info fw-bold py-3 rounded-pill shadow pulse-btn" onclick="predictLength()">CALCULATE</button>
                    <button type="submit" form="calcForm" class="btn btn-success fw-bold py-3 rounded-pill shadow" id="injectBtn" disabled>CONFIRM INJECTION</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function predictLength() {
        const btn = document.querySelector('button[onclick="predictLength()"]');
        btn.innerHTML = 'Processing...';
        const data = {
            tonnage: document.getElementById('tonnage').value, freeboard: document.getElementById('freeboard').value,
            speed: document.getElementById('speed').value, temp: document.getElementById('temp').value,
            al: document.getElementById('al').value, s: document.getElementById('s').value,
            si: document.getElementById('si').value, p_initial: document.getElementById('p_initial').value,
            p_before: document.getElementById('p_before').value
        };
        fetch('/calculate_api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
        .then(res => res.json()).then(data => {
            btn.innerHTML = 'CALCULATE';
            if(data.success) {
                document.getElementById('resultDisplay').innerText = data.length_m;
                document.getElementById('timeDisplay').innerText = data.time_min + " min";
                document.getElementById('calculated_length_hidden').value = data.length_m;
                document.getElementById('injectBtn').disabled = false;
            } else { alert(data.error); if(data.redirect) window.location.href = data.redirect; }
        });
    }
</script>
{% endblock %}
        